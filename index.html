<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rafiah Dune Adventure</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      html, body {
        height: 100%;
        margin: 0;
        background: #0d0d0d;
        color: #f0f0f0;
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
      }
      canvas {
        display: block;
        margin: 0 auto;
        image-rendering: pixelated;
        touch-action: none;
      }
      noscript {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.9);
        color: #f8f8f8;
        font-size: 1.2rem;
        z-index: 2147483647;
      }
      #rafiah-debug {
        position: fixed;
        left: 8px;
        bottom: 8px;
        z-index: 2147483647;
        max-width: 60vw;
        max-height: 40vh;
        overflow: auto;
        font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        background: rgba(0, 0, 0, 0.75);
        color: #0f0;
        padding: 8px;
        border: 1px solid #0f0;
        border-radius: 6px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <noscript>يجب تفعيل الجافاسكربت لتجربة مغامرة الطعوس.</noscript>
    <div id="rafiah-debug" hidden></div>
    <script
      defer
      data-phaser-cdn
      src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"
      integrity="sha384-MBgGgVk6odd6JDACUtJ/xCNIUmhCSwN8FklarIYURiDZ6G7uMR2ykZXN0jQTZ8b/"
      crossorigin="anonymous"
    ></script>
    <script>
      (function rafiahBoot() {
        const debugBox = document.getElementById('rafiah-debug');
        function log(...args) {
          const line = args.map(part => {
            if (typeof part === 'string') return part;
            try { return JSON.stringify(part); } catch (_) { return String(part); }
          }).join(' ');
          console.log(...args);
          if (debugBox) {
            debugBox.hidden = false;
            debugBox.append(line + '\n');
            debugBox.scrollTop = debugBox.scrollHeight;
          }
        }
        let bootStarted = false;
        function importMain() {
          if (bootStarted) return;
          bootStarted = true;
          import('data:text/javascript;base64,aW1wb3J0IFByZWxvYWRTY2VuZSBmcm9tICcuL3NjZW5lcy9QcmVsb2FkU2NlbmUuanM/dj0yMDI0MTIwMSc7CmltcG9ydCBMZXZlbFNjZW5lIGZyb20gJy4vc2NlbmVzL0xldmVsU2NlbmUuanM/dj0yMDI0MTIwMSc7CmltcG9ydCBVSVNjZW5lIGZyb20gJy4vc2NlbmVzL1VJU2NlbmUuanM/dj0yMDI0MTIwMSc7Cgpjb25zdCBTSEFSRUQgPSB3aW5kb3cuUkFGSUFIX1NIQVJFRCA/PyB7CiAgY29uZmlnOiBudWxsLAogIGkxOG46IHsgYXI6IHt9LCBlbjoge30gfSwKICBsYW5ndWFnZTogJ2FyJywKICByZWR1Y2VkTW90aW9uOiBmYWxzZSwKICB1bmxvY2tlZFZlaGljbGVzOiBuZXcgU2V0KFsnZ21jJ10pCn07CndpbmRvdy5SQUZJQUhfU0hBUkVEID0gU0hBUkVEOwoKY29uc3QgeyBHYW1lLCBBVVRPLCBTY2FsZSwgRXZlbnRzIH0gPSBQaGFzZXI7Cgpjb25zdCBnYW1lQ29uZmlnID0gewogIHR5cGU6IEFVVE8sCiAgd2lkdGg6IDEyODAsCiAgaGVpZ2h0OiA3MjAsCiAgYmFja2dyb3VuZENvbG9yOiAnIzEwMTQxOCcsCiAgcGFyZW50OiBkb2N1bWVudC5ib2R5LAogIHBpeGVsQXJ0OiB0cnVlLAogIHNjYWxlOiB7CiAgICBtb2RlOiBTY2FsZS5GSVQsCiAgICBhdXRvQ2VudGVyOiBTY2FsZS5DRU5URVJfQk9USAogIH0sCiAgcGh5c2ljczogewogICAgZGVmYXVsdDogJ21hdHRlcicsCiAgICBtYXR0ZXI6IHsKICAgICAgZ3Jhdml0eTogeyB5OiAxLjAgfSwKICAgICAgZGVidWc6IGZhbHNlCiAgICB9CiAgfSwKICBzY2VuZTogW1ByZWxvYWRTY2VuZSwgTGV2ZWxTY2VuZSwgVUlTY2VuZV0KfTsKCmNvbnN0IGdhbWUgPSBuZXcgR2FtZShnYW1lQ29uZmlnKTsKd2luZG93Ll9fUkFGSUFIX0dBTUUgPSBnYW1lOwpjb25zb2xlLmxvZygn4pyFIFBoYXNlci5HYW1lIGNyZWF0ZWQnKTsKClNIQVJFRC5nYW1lID0gZ2FtZTsKU0hBUkVELmV2ZW50cyA9IFNIQVJFRC5ldmVudHMgfHwgbmV3IEV2ZW50cy5FdmVudEVtaXR0ZXIoKTsKZ2FtZS5yZWdpc3RyeS5zZXQoJ3NoYXJlZCcsIFNIQVJFRCk7CgpnYW1lLmV2ZW50cy5vbignbGFuZ3VhZ2UtY2hhbmdlJywgbGFuZyA9PiB7CiAgU0hBUkVELmxhbmd1YWdlID0gbGFuZzsKICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQubGFuZyA9IGxhbmc7CiAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRpciA9IGxhbmcgPT09ICdhcicgPyAncnRsJyA6ICdsdHInOwp9KTsKCmdhbWUuZXZlbnRzLm9uKCdyZWR1Y2VkLW1vdGlvbicsIGVuYWJsZWQgPT4gewogIFNIQVJFRC5yZWR1Y2VkTW90aW9uID0gISFlbmFibGVkOwp9KTsKCnNldFRpbWVvdXQoKCkgPT4gewogIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2NhbnZhcycpOwogIGlmIChjYW52YXMpIHsKICAgIGNvbnNvbGUubG9nKGDinIUgQ2FudmFzIGRldGVjdGVkICgke2NhbnZhcy53aWR0aH3DlyR7Y2FudmFzLmhlaWdodH0pYCk7CiAgfSBlbHNlIHsKICAgIGNvbnNvbGUud2Fybign4pqg77iPIENhbnZhcyBub3QgZm91bmQgeWV0Jyk7CiAgfQp9LCAzMDApOwoKYm9vdHN0cmFwQXN5bmMoKS5jYXRjaChlcnIgPT4gewogIGNvbnNvbGUud2Fybign4pqg77iPIGJvb3RzdHJhcEFzeW5jIGVuY291bnRlcmVkIGVycm9yJywgZXJyKTsKfSk7Cgphc3luYyBmdW5jdGlvbiBib290c3RyYXBBc3luYygpIHsKICBjb25zb2xlLmxvZygn4o+zIEZldGNoaW5nIGNvbmZpZ3VyYXRpb24gJiB0cmFuc2xhdGlvbnMnKTsKICBjb25zdCBbY29uZmlnLCBhciwgZW5dID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgZmV0Y2hKU09OKCcuL2NvbmZpZy5qc29uJyksCiAgICBmZXRjaEpTT04oJy4vaTE4bi9hci5qc29uJyksCiAgICBmZXRjaEpTT04oJy4vaTE4bi9lbi5qc29uJykKICBdKS5jYXRjaChlcnIgPT4gewogICAgY29uc29sZS53YXJuKCfimqDvuI8gY29uZmlnIGZhbGxiYWNrIHVzZWQnLCBlcnIpOwogICAgcmV0dXJuIFsKICAgICAgeyBhdWRpbzogeyBtdXNpYzogdHJ1ZSwgc2Z4OiB0cnVlIH0sIG1vZGU6IHsgZmFtaWx5U2FmZTogdHJ1ZSB9LCB2ZWhpY2xlOiAnZ21jJyB9LAogICAgICB7fSwKICAgICAge30KICAgIF07CiAgfSk7CgogIFNIQVJFRC5jb25maWcgPSBjb25maWc7CiAgU0hBUkVELmkxOG4gPSB7IGFyLCBlbiB9OwogIFNIQVJFRC5sYW5ndWFnZSA9IFNIQVJFRC5sYW5ndWFnZSB8fCAnYXInOwogIFNIQVJFRC51bmxvY2tlZFZlaGljbGVzID0gbmV3IFNldChjb25maWcudmVoaWNsZSA9PT0gJ3ByYWRvJyA/IFsnZ21jJywgJ3ByYWRvJ10gOiBbJ2dtYyddKTsKCiAgZ2FtZS5yZWdpc3RyeS5zZXQoJ2NvbmZpZycsIGNvbmZpZyk7CiAgZ2FtZS5yZWdpc3RyeS5zZXQoJ2xhbmcnLCBTSEFSRUQubGFuZ3VhZ2UpOwogIGdhbWUucmVnaXN0cnkuc2V0KCdsYW5ndWFnZScsIFNIQVJFRC5sYW5ndWFnZSk7CiAgZ2FtZS5yZWdpc3RyeS5zZXQoJ2xldmVsLWRhdGEnLCBudWxsKTsKICBnYW1lLmV2ZW50cy5lbWl0KCdyYWZpYWgtc2hhcmVkLXJlYWR5JywgU0hBUkVEKTsKCiAgY29uc29sZS5sb2coJ+KchSBjb25maWcgbG9hZGVkJyk7CiAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQoJ3JhZmlhaDpjb25maWctbG9hZGVkJywgeyBkZXRhaWw6IGNvbmZpZyB9KSk7CiAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmxhbmcgPSBTSEFSRUQubGFuZ3VhZ2U7CiAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmRpciA9IFNIQVJFRC5sYW5ndWFnZSA9PT0gJ2FyJyA/ICdydGwnIDogJ2x0cic7Cn0KCmFzeW5jIGZ1bmN0aW9uIGZldGNoSlNPTih1cmwpIHsKICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwgeyBjYWNoZTogJ25vLXN0b3JlJyB9KTsKICBpZiAoIXJlc3BvbnNlLm9rKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7dXJsfSAke3Jlc3BvbnNlLnN0YXR1c30gJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApOwogIH0KICByZXR1cm4gcmVzcG9uc2UuanNvbigpOwp9Cgp3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmFmaWFoLWxldmVsLXJlYWR5JywgKCkgPT4gewogIGNvbnNvbGUubG9nKCfinIUgTGV2ZWwgdmlzaWJsZSAoY2FudmFzIHByZXNlbnQpJyk7CiAgY29uc29sZS5sb2coJ+KchSBCb290IE9LJyk7Cn0pOwo=')
            .then(() => log('✅ Boot: main.js imported'))
            .catch(err => log('❌ Boot import failed', err));
        }
        log('⏳ Waiting for Phaser (CDN) ...');
        const cdn = document.querySelector('script[data-phaser-cdn]');
        if (cdn) {
          cdn.addEventListener('load', () => {
            log('✅ Phaser CDN script loaded');
            if (window.Phaser) startWhenReady();
          });
          cdn.addEventListener('error', () => {
            log('⚠️ Phaser CDN failed to load from jsDelivr, attempting fallback…');
            const fallback = document.createElement('script');
            fallback.defer = true;
            fallback.src = 'https://unpkg.com/phaser@3.70.0/dist/phaser.min.js';
            fallback.addEventListener('load', () => {
              log('✅ Phaser fallback CDN loaded');
              if (window.Phaser) startWhenReady();
            });
            fallback.addEventListener('error', () => log('💥 Phaser fallback CDN load failed'));
            document.head.appendChild(fallback);
          });
        } else {
          log('⚠️ Phaser CDN script tag not found');
        }
        function startWhenReady() {
          if (window.Phaser) {
            log('✅ Phaser ready (window.Phaser found)');
            importMain();
            return true;
          }
          return false;
        }
        (function poll() {
          if (startWhenReady()) return;
          setTimeout(poll, 50);
        })();
        window.addEventListener('error', ev => log('💥 window.onerror:', ev.message || ev.type));
        window.addEventListener('unhandledrejection', ev => log('💥 unhandledrejection:', String(ev.reason || ev)));
      })();
    </script>
  </body>
</html>
