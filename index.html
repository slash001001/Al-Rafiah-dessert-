<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>صعود الطعس – GMC Sierra 2016 (MVP+)</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Helvetica Neue", Arial, sans-serif;
      --bg:#0b0f18;
      --text:#f5f7ff;
      --accent:#ef3a5d;
      --hud:#111727;
      --danger:#ff6b6b;
    }
    *, *::before, *::after {
      box-sizing:border-box;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }
    #app {
      position:relative;
      width:100%;
      height:100vh;
      overflow:hidden;
      padding-bottom:env(safe-area-inset-bottom);
      padding-top:env(safe-area-inset-top);
    }
    canvas {
      width:100%;
      height:100%;
      display:block;
      background:linear-gradient(#102347,#203a75 55%,#8a5a32);
    }
    #topBar {
      position:absolute;
      inset:env(safe-area-inset-top) 0 auto 0;
      display:flex;
      gap:0.6rem;
      flex-wrap:wrap;
      align-items:center;
      padding:0.6rem 1.2rem;
      font-size:0.95rem;
      background:rgba(10,14,22,0.78);
      backdrop-filter:blur(18px);
      z-index:9;
      transition:background 0.25s ease;
    }
    #topBar.invert {
      background:rgba(111,19,30,0.82);
    }
    #topBar .hud-item {
      display:flex;
      align-items:center;
      gap:0.35rem;
      white-space:nowrap;
    }
    #topBar strong {
      font-size:1.05rem;
      color:#fcea5c;
    }
    .progress {
      position:relative;
      flex:1 1 100%;
      height:0.45rem;
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,0.15);
    }
    .progress .fill {
      position:absolute;
      inset:0;
      width:0%;
      background:linear-gradient(90deg,#f43f5e,#ff8a3d);
      transition:width 0.12s ease-out;
    }
    #toast, #banner {
      position:absolute;
      left:50%;
      transform:translateX(-50%) translateY(12px);
      padding:0.75rem 1.5rem;
      background:rgba(0,0,0,0.78);
      backdrop-filter:blur(20px);
      border-radius:16px;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.25s ease, transform 0.25s ease;
      z-index:10;
      text-align:center;
      line-height:1.5;
    }
    #toast {
      bottom:22%;
      font-size:0.95rem;
    }
    #banner {
      top:24%;
      font-size:1.28rem;
      font-weight:600;
      max-width:82%;
    }
    #toast.visible, #banner.visible {
      opacity:1;
      transform:translate(-50%,0);
    }
    #qte {
      position:absolute;
      bottom:22%;
      left:50%;
      transform:translateX(-50%);
      width:min(480px,80vw);
      background:rgba(15,22,36,0.9);
      border:2px solid rgba(255,255,255,0.18);
      border-radius:18px;
      padding:1.1rem 1.2rem;
      display:none;
      z-index:11;
    }
    #qte.active {
      display:block;
    }
    #qteTitle {
      font-size:1.05rem;
      margin-bottom:0.7rem;
      font-weight:bold;
    }
    #qteBar {
      position:relative;
      height:0.6rem;
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,0.15);
      margin-bottom:0.8rem;
    }
    #qteFill {
      position:absolute;
      inset:0;
      width:0%;
      background:linear-gradient(90deg,#22c55e,#0ea5e9);
      transition:width 0.08s ease-out;
    }
    #qteKeys {
      display:flex;
      gap:0.9rem;
    }
    #qteKeys button {
      flex:1;
      font-size:1.45rem;
      padding:0.7rem 0;
      background:#1d273b;
      border:2px solid rgba(255,255,255,0.25);
      border-radius:14px;
      color:#fff;
    }
    #controls {
      position:absolute;
      inset:auto 0 0 0;
      padding:0.85rem 1.2rem calc(1rem + env(safe-area-inset-bottom));
      display:grid;
      gap:0.75rem;
      grid-template-columns:repeat(5,minmax(0,1fr));
      z-index:9;
    }
    #controls button {
      padding:0.95rem 0.75rem;
      font-size:1.32rem;
      border:none;
      border-radius:18px;
      background:rgba(17,24,39,0.82);
      color:#fff;
      box-shadow:0 8px 20px rgba(0,0,0,0.35);
    }
    #controls .wide {
      grid-column:span 2;
    }
    #controls .hidden {
      visibility:hidden;
    }
    #flipBtn {
      position:absolute;
      bottom:calc(5.4rem + env(safe-area-inset-bottom));
      left:0.9rem;
      padding:0.35rem 0.7rem;
      font-size:0.9rem;
      border:none;
      border-radius:12px;
      background:rgba(0,0,0,0.4);
      color:#fff;
      z-index:8;
    }
    #end {
      position:absolute;
      inset:0;
      background:rgba(6,10,16,0.85);
      backdrop-filter:blur(20px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:12;
    }
    #end.active {
      display:flex;
    }
    #endCard {
      width:min(420px,88vw);
      background:rgba(15,22,32,0.92);
      border-radius:24px;
      padding:2.2rem 2rem;
      text-align:center;
      box-shadow:0 24px 48px rgba(0,0,0,0.38);
    }
    #endCard h1 {
      margin:0 0 1rem;
      font-size:1.5rem;
    }
    #endCard .stat {
      margin:0.4rem 0;
      font-size:1.05rem;
    }
    #endCard button {
      margin-top:1.6rem;
      padding:0.85rem 2.2rem;
      border:none;
      border-radius:999px;
      font-size:1.05rem;
      background:linear-gradient(90deg,#f43f5e,#ff8a3d);
      color:#fff;
    }
    #err {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:#431219;
      color:#ffd1d9;
      padding:1rem 1.4rem;
      border-radius:16px;
      display:none;
      z-index:100;
    }
    @media (min-width:920px) {
      #controls {
        grid-template-columns:repeat(8,minmax(0,1fr));
        width:min(960px,100%);
        margin-inline:auto;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <canvas id="scene" aria-label="ساحة اللعبة"></canvas>
    <div id="topBar">
      <span class="hud-item">🏎️ سرعة <strong id="hudSpeed">0</strong> km/h</span>
      <span class="hud-item">⭐ نقاط <strong id="hudScore">0</strong></span>
      <span class="hud-item">🔥 كومبو <strong id="hudCombo">x1.00</strong> <small id="hudComboTime"></small></span>
      <span class="hud-item">⚡ نيترو <strong id="hudNitro">2</strong></span>
      <span class="hud-item">🪝 ونش <strong id="hudWinch">1</strong></span>
      <span class="hud-item">⏱️ وقت <strong id="hudTime">60.0</strong>s</span>
      <span id="phase">🌵 إحماء</span>
      <div class="progress"><div class="fill" id="progressFill"></div></div>
    </div>
    <div id="toast"></div>
    <div id="banner"></div>
    <div id="qte">
      <div id="qteTitle">☁️ تغريز! بدّل K و L بسرعة</div>
      <div id="qteBar"><div id="qteFill"></div></div>
      <div id="qteKeys">
        <button type="button" data-qte="K">K</button>
        <button type="button" data-qte="L">L</button>
      </div>
    </div>
    <div id="end">
      <div id="endCard">
        <h1>😂 طبخنا… بس نسينا الملح 🧂</h1>
        <p class="stat">النقاط: <strong id="endScore">0</strong></p>
        <p class="stat">الزمن: <strong id="endTime">0.0s</strong></p>
        <p class="stat">أعلى كومبو: <strong id="endCombo">x1.00</strong></p>
        <p class="stat">أفضل نتيجة محفوظة: <strong id="endPB">--</strong></p>
        <button type="button" id="restartBtn">إعادة</button>
      </div>
    </div>
    <div id="controls">
      <button type="button" data-hold="left">◀︎</button>
      <button type="button" data-hold="right">▶︎</button>
      <button type="button" data-tap="jump" class="wide">⬆︎</button>
      <button type="button" data-tap="nitro">⚡</button>
      <button type="button" data-tap="winch">🪝</button>
      <button type="button" data-tap="choice1">1</button>
      <button type="button" data-tap="choice2">2</button>
      <button type="button" data-tap="choice3">3</button>
      <button type="button" data-hold="qteK" class="hidden">K</button>
      <button type="button" data-hold="qteL" class="hidden">L</button>
    </div>
    <button type="button" id="flipBtn">↔️ قلب الاتجاه</button>
    <div id="err"></div>
  </div>
  <script>
    // إعداد عام
    'use strict';
    const canvas = document.getElementById('scene');
    const ctx = canvas.getContext('2d');
    const topBarEl = document.getElementById('topBar');
    const dpr = window.devicePixelRatio || 1;

    const hud = {
      speed: document.getElementById('hudSpeed'),
      score: document.getElementById('hudScore'),
      combo: document.getElementById('hudCombo'),
      comboTime: document.getElementById('hudComboTime'),
      nitro: document.getElementById('hudNitro'),
      winch: document.getElementById('hudWinch'),
      time: document.getElementById('hudTime'),
      progress: document.getElementById('progressFill'),
      phase: document.getElementById('phase'),
    };
    const ui = {
      toast: document.getElementById('toast'),
      banner: document.getElementById('banner'),
      qte: document.getElementById('qte'),
      qteFill: document.getElementById('qteFill'),
      end: document.getElementById('end'),
      endScore: document.getElementById('endScore'),
      endTime: document.getElementById('endTime'),
      endCombo: document.getElementById('endCombo'),
      endPB: document.getElementById('endPB'),
      err: document.getElementById('err'),
    };
    const controls = document.querySelectorAll('#controls button');
    const qteButtons = document.querySelectorAll('#qteKeys button');
    const restartBtn = document.getElementById('restartBtn');
    const flipBtn = document.getElementById('flipBtn');

    // دوال مساعدة
    const clamp = (v, mn, mx) => Math.max(mn, Math.min(mx, v));
    const lerp = (a, b, t) => a + (b - a) * t;
    const rnd = (min, max) => Math.random() * (max - min) + min;
    const easeOut = t => 1 - Math.pow(1 - t, 2);
    const kmh = v => Math.abs(v) * 0.42;
    const vib = pattern => navigator.vibrate?.(pattern);

    // ثوابت العالم والفيزياء
    const WORLD = {
      finish: 9800,
      chairX: 1600,
      sandStart: 2600,
      sandEnd: 6400,
      dogsStart: 4200,
      dogsEnd: 7800,
      gateX: 7950,
      bossX: 8600,
      flagX: 9300,
      baseline: 430,
    };
    const CAR = {
      width: 160,
      height: 68,
      wheelRadius: 22,
      accel: 240,
      friction: 14,
      airDrag: 0.6,
      gravity: 880,
      jump: 520,
      maxSpeed: 340,
      maxReverse: -130,
      nitroForce: 420,
      winchBoost: 200,
    };
    const GAME = {
      duration: 70,
      maxTime: 95,
      comboWindow: 4,
      comboStep: 0.5,
      comboMax: 4,
      dogBase: 100,
      ooobaaaBonus: 50,
      shalimarBoost: 300,
      chairBonus: 100,
      chairPenalty: 50,
      qteReward: 50,
      bossReward: 500,
      bossPenalty: 200,
      V_hitMin: 6.5,
    };

    // نظام الصوت
    const sound = {
      ctx: null,
      engineOsc: null,
      engineGain: null,
      unlocked: false,
    };
    const snd = {};

    // حالة المدخلات
    const input = {
      left: false,
      right: false,
      jumpQueued: false,
      nitroQueued: false,
      winchQueued: false,
      flip: 1,
    };

    // حالة السيارة
    const car = {
      x: 80,
      y: WORLD.baseline,
      vx: 80,
      vy: 0,
      onGround: true,
      speedKMH: 0,
      s: 0,
    };

    // حالة اللعب العامة
    const state = {
      running: true,
      time: 0,
      score: 0,
      comboLevel: 0,
      comboTimer: 0,
      maxCombo: 1,
      nitro: 2,
      winch: 1,
      nitroTimer: 0,
      boostTimer: 0,
      hitSlowTimer: 0,
      toastTimer: 0,
      bannerTimer: 0,
      phase: '🌵 إحماء',
      qte: null,
      qteCooldown: 0,
      chairTouched: false,
      chairResolved: false,
      shalimarTriggered: false,
      shalimarChoice: null,
      massageActive: false,
      ooobaaaCooldown: 8,
      helicopterTriggered: false,
      helicopterTimer: 0,
      bossActive: false,
      bossTimer: 0,
      bossSequence: [],
      bossIndex: 0,
      controlsFlipped: 0,
      choiceEvent: null,
      bossResolved: false,
      ended: false,
      pb: null,
    };

    // مصفوفات الكيانات
    const dogs = [];
    const spectators = [];
    const tracks = [];
    const blood = [];
    const sandBursts = [];

    // توليد الكلاب والمتفرجين
    (function generateEntities() {
      const dogCount = 13;
      for (let i = 0; i < dogCount; i++) {
        const x = WORLD.dogsStart + 160 + i * rnd(210, 310);
        dogs.push({
          x,
          y: sampleGround(x),
          hit: false,
          missed: false,
          timer: 0,
          fade: 1,
        });
      }
      for (let i = 0; i < 16; i++) {
        const x = 800 + i * 520 + rnd(-100, 100);
        spectators.push({
          x,
          offset: rnd(60, 120),
          sway: Math.random() * Math.PI * 2,
          color: `hsl(${rnd(0,360)},62%,60%)`,
        });
      }
    })();

    // قراءة أفضل نتيجة محفوظة
    try {
      const raw = localStorage.getItem('sierra_pb_plus');
      if (raw) state.pb = JSON.parse(raw);
    } catch (err) {
      console.warn('PB load failed', err);
    }

    // ضبط حجم اللوحة
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // إنشاء الصوت بعد التفاعل الأول
    function unlockAudio() {
      if (sound.unlocked) return;
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const actx = new AudioCtx();
        const gain = actx.createGain();
        gain.gain.value = 0;
        gain.connect(actx.destination);
        const osc = actx.createOscillator();
        osc.type = 'sawtooth';
        osc.frequency.value = 0;
        osc.connect(gain);
        osc.start();
        sound.ctx = actx;
        sound.engineGain = gain;
        sound.engineOsc = osc;
        sound.unlocked = true;
        showToast('🎧 الصوت جاهز', 1.5);
      } catch (err) {
        ui.err.textContent = '⚠️ تعذّر تفعيل الصوت';
        ui.err.style.display = 'block';
      }
    }

    function playEffect(name, freq = 440, duration = 0.22, type = 'triangle', gainValue = 0.35) {
      if (!sound.unlocked || !sound.ctx) return;
      const now = sound.ctx.currentTime;
      const osc = sound.ctx.createOscillator();
      const gain = sound.ctx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq + rnd(-20, 20), now);
      gain.gain.setValueAtTime(gainValue, now);
      gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
      osc.connect(gain);
      gain.connect(sound.ctx.destination);
      osc.start(now);
      osc.stop(now + duration);
    }

    function updateEngineAudio() {
      if (!sound.unlocked || !sound.engineOsc || !sound.engineGain) return;
      const targetFreq = 70 + car.speedKMH * 4;
      sound.engineOsc.frequency.value = lerp(sound.engineOsc.frequency.value, targetFreq, 0.15);
      const baseGain = clamp(car.speedKMH / 210, 0.05, 0.38);
      const boostGain = state.nitroTimer > 0 ? 0.22 : 0;
      sound.engineGain.gain.value = lerp(sound.engineGain.gain.value, baseGain + boostGain, 0.1);
    }

    // عرض الرسائل
    function showToast(msg, duration = 1.4) {
      ui.toast.textContent = msg;
      ui.toast.classList.add('visible');
      state.toastTimer = duration;
    }
    function showBanner(msg, duration = 2.2) {
      ui.banner.textContent = msg;
      ui.banner.classList.add('visible');
      state.bannerTimer = duration;
    }
    function hideBanner() {
      ui.banner.classList.remove('visible');
      state.bannerTimer = 0;
    }

    // توليد تضاريس الأرض
    function sampleGround(x) {
      try {
        const slope = Math.min(280, x * 0.037);
        const undulation = Math.sin(x * 0.0026) * 30 + Math.sin((x + 600) * 0.0011) * 24;
        const dunes = Math.sin((x + 900) * 0.00033) * 44;
        const crest = x > WORLD.flagX ? (x - WORLD.flagX) * 0.16 : 0;
        const raw = WORLD.baseline - slope + undulation + dunes - crest;
        const ground = clamp(raw, 170, canvas.height / dpr - 45);
        return ground;
      } catch (err) {
        ui.err.textContent = '⚠️ sampleGround خطأ';
        ui.err.style.display = 'block';
        return WORLD.baseline;
      }
    }

    // الكومبو والنقاط
    function getComboMultiplier() {
      const level = clamp(state.comboLevel, 0, GAME.comboMax - 1);
      return 1 + GAME.comboStep * level;
    }
    function registerCombo() {
      state.comboLevel = clamp(state.comboLevel + 1, 0, GAME.comboMax - 1);
      state.comboTimer = GAME.comboWindow;
      const combo = getComboMultiplier();
      state.maxCombo = Math.max(state.maxCombo, combo);
    }
    function resetCombo() {
      state.comboLevel = 0;
      state.comboTimer = 0;
    }
    function addScore(amount) {
      state.score = Math.max(0, state.score + amount);
    }

    // QTE التغريز
    function startQTE() {
      if (state.qte) return;
      state.qte = {
        progress: 0,
        expect: 'K',
        timer: 3,
      };
      ui.qte.classList.add('active');
      toggleQTEButtons(true);
      showBanner('☁️ الرمل ناعم! اضرب K / L بسرعة', 3);
      playEffect('qteStart', 520, 0.35, 'square', 0.28);
    }
    function endQTE(success) {
      if (!state.qte) return;
      ui.qte.classList.remove('active');
      toggleQTEButtons(false);
      hideBanner();
      if (success) {
        addScore(GAME.qteReward);
        state.boostTimer = Math.max(state.boostTimer, 1.1);
        showToast('✅ فكّ التغريز +' + GAME.qteReward);
        playEffect('qteSuccess', 720, 0.4, 'sawtooth', 0.32);
      } else {
        showToast('❌ التغريز خلّانا!', 1.3);
        playEffect('qteFail', 210, 0.4, 'sine', 0.24);
      }
      state.qte = null;
      state.qteCooldown = 5;
    }
    function handleQTEKey(key) {
      if (!state.qte) return;
      if (key === state.qte.expect) {
        state.qte.progress = clamp(state.qte.progress + 0.18, 0, 1);
        state.qte.expect = key === 'K' ? 'L' : 'K';
        playEffect('qteTap', 640, 0.25, 'triangle', 0.28);
        if (state.qte.progress >= 1) endQTE(true);
      } else {
        state.qte.progress = clamp(state.qte.progress - 0.08, 0, 1);
        playEffect('miss', 220, 0.3, 'sine', 0.22);
      }
      ui.qteFill.style.width = (state.qte ? state.qte.progress * 100 : 0).toFixed(1) + '%';
    }
    function toggleQTEButtons(show) {
      controls.forEach(btn => {
        if (btn.dataset.hold === 'qteK' || btn.dataset.hold === 'qteL') {
          btn.classList.toggle('hidden', !show);
        }
      });
    }

    // أحداث الطقطقة
    function eventOoobaaa() {
      state.ooobaaaCooldown = 9;
      state.boostTimer = Math.max(state.boostTimer, 1.4);
      addScore(GAME.ooobaaaBonus);
      showBanner('🗣️ اوووباااا! +' + GAME.ooobaaaBonus, 1.4);
      playEffect('ooobaaa', 660, 0.42, 'square', 0.4);
      vib([40, 30, 40]);
    }

    function startChoiceEvent(name, text, options) {
      state.choiceEvent = {
        name,
        options,
        timer: 1.0,
        default: options.default ?? 2,
      };
      showBanner(text, 3);
    }

    function resolveChoice(option) {
      if (!state.choiceEvent) return;
      const { name } = state.choiceEvent;
      const choice = option ?? state.choiceEvent.default;
      hideBanner();
      state.choiceEvent = null;
      switch (name) {
        case 'massage':
          if (choice === 1) {
            addScore(100);
            showToast('💆‍♂️ بعد الخط! +100', 1.4);
            playEffect('boost', 640, 0.35, 'sawtooth', 0.32);
          } else if (choice === 2) {
            showToast('🙅‍♂️ لا يا الحبيب', 1.1);
            playEffect('miss', 260, 0.3, 'sine', 0.24);
          } else {
            car.x += 40;
            showToast('😂 تعال ندف! اندفعنا', 1.4);
            playEffect('boost', 760, 0.32, 'triangle', 0.3);
          }
          break;
        case 'shalimar':
          if (choice === 1) {
            addScore(GAME.shalimarBoost);
            state.boostTimer = Math.max(state.boostTimer, 2.5);
            showToast('🍗 كبسة! +' + GAME.shalimarBoost, 1.8);
            playEffect('boost', 820, 0.5, 'sawtooth', 0.4);
          } else if (choice === 2) {
            car.vx *= 0.8;
            showToast('🍛 برياني… ثقلنا شوي', 1.8);
            playEffect('miss', 280, 0.3, 'sine', 0.28);
          } else {
            if (Math.random() < 0.5) {
              state.nitro++;
              showToast('🎁 مفاجأة: نيترو إضافي!', 1.6);
            } else {
              state.boostTimer = Math.max(state.boostTimer, 1.2);
              showToast('💨 غبرة مجنونة!', 1.6);
            }
            playEffect('boost', 660, 0.4, 'triangle', 0.32);
          }
          break;
      }
    }

    function eventMassage() {
      startChoiceEvent('massage', '🙋‍♂️ مساج؟ 1) بعد الخط 2) لا يا الحبيب 3) تعال ندف', { default: 2 });
      playEffect('boss', 300, 0.3, 'square', 0.28);
    }

    function eventShalimar() {
      state.shalimarTriggered = true;
      startChoiceEvent('shalimar', '🍽️ شاليمار! 1) كبسة 2) برياني 3) مفاجأة', { default: 2 });
    }

    function eventHelicopter() {
      state.helicopterTriggered = true;
      const pull = Math.random() < 0.5;
      if (pull) {
        car.vx += 180;
        state.boostTimer = Math.max(state.boostTimer, 1.6);
        showBanner('🚁 هليكوبتر — سحب! امسك الحبل', 1.8);
        playEffect('boost', 700, 0.5, 'sawtooth', 0.42);
        sandBursts.push({ x: car.x - 60, y: car.y - 14, life: 1.2, dir: -1 });
      } else {
        car.vx *= 0.8;
        showBanner('🚁 هليكوبتر — غبرة!', 1.8);
        playEffect('miss', 200, 0.5, 'triangle', 0.34);
        sandBursts.push({ x: car.x + 60, y: car.y - 18, life: 1.2, dir: 1 });
      }
      vib([40, 40, 40]);
    }

    function eventBoss() {
      state.bossActive = true;
      state.controlsFlipped = 2;
      state.bossTimer = 1.5;
      state.bossSequence = ['ArrowUp', 'ArrowLeft', 'ArrowUp'];
      state.bossIndex = 0;
      showBanner('🤪 Dumb & Dumber قلبوا الأزرار! نفّذ ↑ ← ↑ بسرعة', 3);
      playEffect('boss', 180, 0.5, 'square', 0.4);
      vib([80, 60, 80]);
    }

    function handleBossKey(key) {
      if (!state.bossActive) return;
      const target = state.bossSequence[state.bossIndex];
      if (key === target) {
        state.bossIndex++;
        playEffect('qteTap', 580, 0.25, 'triangle', 0.3);
        if (state.bossIndex >= state.bossSequence.length) {
          state.bossActive = false;
          addScore(GAME.bossReward);
          state.nitro = Math.max(state.nitro, 1);
          state.winch = Math.max(state.winch, 1);
          showToast('🤜🤛 هزمت Dumb & Dumber! +' + GAME.bossReward, 1.8);
          playEffect('boost', 680, 0.5, 'sawtooth', 0.42);
        }
      } else {
        state.bossActive = false;
        addScore(-GAME.bossPenalty);
        showToast('🙃 البوس ضحك عليك! -' + GAME.bossPenalty, 1.8);
        playEffect('miss', 220, 0.3, 'sine', 0.28);
      }
    }

    // استعمال النيترو والونش
    function useNitro() {
      if (state.nitro <= 0) return;
      state.nitro--;
      state.nitroTimer = 2.5;
      state.boostTimer = Math.max(state.boostTimer, 2.5);
      showToast('⚡ نيترو!', 1.2);
      playEffect('boost', 840, 0.55, 'sawtooth', 0.45);
      vib(80);
    }
    function useWinch() {
      if (state.winch <= 0) return;
      state.winch--;
      car.vx += CAR.winchBoost;
      showToast('🪝 ونش شدّنا', 1.4);
      playEffect('winch', 420, 0.4, 'square', 0.32);
      vib([60, 40, 60]);
    }

    // القفز
    function tryJump() {
      if (!car.onGround) return;
      car.vy = -CAR.jump;
      car.onGround = false;
      playEffect('jump', 680, 0.35, 'triangle', 0.32);
      vib(40);
    }

    // تحديث HUD
    function updateHUD(dt) {
      hud.speed.textContent = car.speedKMH.toFixed(0);
      hud.score.textContent = Math.round(state.score);
      hud.combo.textContent = 'x' + getComboMultiplier().toFixed(2);
      hud.comboTime.textContent = state.comboTimer > 0 ? '(' + state.comboTimer.toFixed(1) + 's)' : '';
      hud.nitro.textContent = state.nitro;
      hud.winch.textContent = state.winch;
      const remain = clamp(GAME.duration - state.time, 0, 999);
      hud.time.textContent = remain.toFixed(1);
      hud.phase.textContent = state.phase;
      const prog = clamp(car.x / WORLD.finish, 0, 1);
      hud.progress.style.width = (prog * 100).toFixed(1) + '%';
      if (state.controlsFlipped > 0) topBarEl.classList.add('invert');
      else topBarEl.classList.remove('invert');
      if (state.toastTimer > 0) {
        state.toastTimer -= dt;
        if (state.toastTimer <= 0) ui.toast.classList.remove('visible');
      }
      if (state.bannerTimer > 0) {
        state.bannerTimer -= dt;
        if (state.bannerTimer <= 0) hideBanner();
      }
    }

    // رسم الخلفية
    function drawSky(cameraX) {
      const w = canvas.width / dpr;
      const h = canvas.height / dpr;
      const grd = ctx.createLinearGradient(0, 0, 0, h);
      grd.addColorStop(0, '#09142b');
      grd.addColorStop(0.52, '#1a2f5a');
      grd.addColorStop(1, '#6f4a2b');
      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, w, h);
      ctx.fillStyle = 'rgba(193,139,82,0.45)';
      ctx.beginPath();
      for (let i = -1; i <= 4; i++) {
        const baseX = (i * 520) - (cameraX * 0.12 % 520);
        ctx.quadraticCurveTo(baseX + 120, h * 0.58 + Math.sin(i) * 16, baseX + 260, h * 0.62);
      }
      ctx.lineTo(w, h);
      ctx.lineTo(0, h);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = 'rgba(212,158,94,0.55)';
      ctx.beginPath();
      for (let i = -1; i <= 4; i++) {
        const baseX = (i * 580) - (cameraX * 0.26 % 580);
        ctx.quadraticCurveTo(baseX + 160, h * 0.7 + Math.sin(i + 2) * 20, baseX + 320, h * 0.74);
      }
      ctx.lineTo(w, h);
      ctx.lineTo(0, h);
      ctx.closePath();
      ctx.fill();
    }

    // رسم الأرض
    function drawGround(cameraX) {
      const w = canvas.width / dpr;
      const h = canvas.height / dpr;
      ctx.beginPath();
      const step = 24;
      for (let screenX = -step; screenX <= w + step; screenX += step) {
        const worldX = screenX + cameraX;
        const groundY = sampleGround(worldX);
        if (screenX === -step) ctx.moveTo(screenX, groundY);
        else ctx.lineTo(screenX, groundY);
      }
      ctx.lineTo(w, h);
      ctx.lineTo(0, h);
      ctx.closePath();
      ctx.fillStyle = '#8a5d37';
      ctx.fill();
      if (car.x > WORLD.sandStart) {
        ctx.fillStyle = 'rgba(230,196,122,0.18)';
        const sx = Math.max(0, WORLD.sandStart - cameraX);
        const ex = Math.min(w, WORLD.sandEnd - cameraX);
        ctx.fillRect(sx, 0, ex - sx, h);
      }
    }

    // رسم المتفرجين
    function drawSpectators(cameraX, dt) {
      spectators.forEach(sp => {
        const sx = sp.x - cameraX;
        if (sx < -120 || sx > canvas.width / dpr + 120) return;
        const ground = sampleGround(sp.x);
        const sy = ground - sp.offset + Math.sin(sp.sway) * 4;
        sp.sway += dt * 2;
        ctx.fillStyle = sp.color;
        ctx.beginPath();
        ctx.ellipse(sx, sy, 12, 24, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#1a1f2b';
        ctx.fillRect(sx - 10, sy, 20, 34);
      });
    }

    // رسم الكرسي
    function drawChair(cameraX) {
      const sx = WORLD.chairX - cameraX;
      if (sx < -160 || sx > canvas.width / dpr + 160) return;
      const sy = sampleGround(WORLD.chairX);
      ctx.fillStyle = '#5b2b1a';
      ctx.fillRect(sx - 16, sy - 54, 32, 12);
      ctx.fillRect(sx - 18, sy - 44, 36, 32);
      ctx.fillRect(sx - 12, sy - 24, 10, 26);
      ctx.fillRect(sx + 4, sy - 24, 10, 26);
    }

    // رسم بوابة شاليمار
    function drawGate(cameraX) {
      const sx = WORLD.gateX - cameraX;
      if (sx < -260 || sx > canvas.width / dpr + 260) return;
      const groundY = sampleGround(WORLD.gateX);
      ctx.save();
      ctx.translate(sx, groundY - 140);
      ctx.strokeStyle = 'rgba(255,255,255,0.6)';
      ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.moveTo(-90, 140);
      ctx.lineTo(-90, 0);
      ctx.quadraticCurveTo(0, -50, 90, 0);
      ctx.lineTo(90, 140);
      ctx.stroke();
      ctx.fillStyle = 'rgba(255,255,255,0.14)';
      ctx.fillRect(-78, 20, 156, 100);
      ctx.fillStyle = '#ffb347';
      ctx.font = 'bold 24px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('شاليمار', 0, 76);
      ctx.restore();
    }

    // رسم منطقة البوس
    function drawBossZone(cameraX) {
      const sx = WORLD.bossX - cameraX;
      if (sx < -300 || sx > canvas.width / dpr + 300) return;
      const groundY = sampleGround(WORLD.bossX);
      ctx.fillStyle = 'rgba(255,96,96,0.12)';
      ctx.fillRect(sx - 200, groundY - 200, 400, 200);
      ctx.strokeStyle = 'rgba(255,96,96,0.7)';
      ctx.setLineDash([18, 10]);
      ctx.strokeRect(sx - 180, groundY - 160, 360, 180);
      ctx.setLineDash([]);
    }

    // رسم خط النهاية
    function drawFinish(cameraX) {
      const sx = WORLD.flagX - cameraX;
      if (sx < -200 || sx > canvas.width / dpr + 200) return;
      const groundY = sampleGround(WORLD.flagX);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(sx - 4, groundY - 160, 8, 160);
      ctx.fillStyle = '#ef3a5d';
      ctx.fillRect(sx, groundY - 160, 72, 42);
      ctx.fillStyle = '#000';
      ctx.font = 'bold 22px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('🏁', sx + 36, groundY - 130);
    }

    // آثار الكفر
    function addTrack(x, y) {
      tracks.push({ x, y, life: 1.6 });
    }
    function drawTracks(cameraX, dt) {
      ctx.strokeStyle = 'rgba(46,34,24,0.35)';
      ctx.lineWidth = 4;
      tracks.forEach(track => {
        track.life -= dt;
        if (track.life <= 0) return;
        const sx = track.x - cameraX;
        ctx.globalAlpha = clamp(track.life, 0, 1);
        ctx.beginPath();
        ctx.moveTo(sx - 12, track.y);
        ctx.lineTo(sx + 12, track.y + 2);
        ctx.stroke();
      });
      ctx.globalAlpha = 1;
      for (let i = tracks.length - 1; i >= 0; i--) if (tracks[i].life <= 0) tracks.splice(i, 1);
    }

    // دم وغبرة
    function spawnBlood(x, y) {
      for (let i = 0; i < 6; i++) {
        blood.push({ x, y, vx: rnd(-40, 40), vy: rnd(-60, -20), life: 0.6 });
      }
    }
    function drawBlood(cameraX, dt) {
      blood.forEach(p => {
        p.life -= dt;
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.vy += 220 * dt;
        if (p.life <= 0) p.life = 0;
        const alpha = clamp(p.life / 0.6, 0, 1) * 0.6;
        ctx.fillStyle = `rgba(200,0,0,${alpha.toFixed(3)})`;
        ctx.beginPath();
        ctx.arc(p.x - cameraX, p.y, 6, 0, Math.PI * 2);
        ctx.fill();
      });
      for (let i = blood.length - 1; i >= 0; i--) if (blood[i].life <= 0) blood.splice(i, 1);
    }
    function drawSand(cameraX, dt) {
      sandBursts.forEach(b => {
        b.life -= dt;
        const alpha = clamp(b.life, 0, 1);
        const sx = b.x - cameraX + (1 - alpha) * 80 * b.dir;
        ctx.fillStyle = `rgba(232,200,140,${alpha.toFixed(3)})`;
        ctx.beginPath();
        ctx.ellipse(sx, b.y, 38 * alpha, 16 * alpha, 0, 0, Math.PI * 2);
        ctx.fill();
      });
      for (let i = sandBursts.length - 1; i >= 0; i--) if (sandBursts[i].life <= 0) sandBursts.splice(i, 1);
    }

    // رسم الكلاب
    function drawDogs(cameraX, dt) {
      dogs.forEach(dog => {
        const sx = dog.x - cameraX;
        if (sx < -200 || sx > canvas.width / dpr + 200) return;
        const groundY = sampleGround(dog.x);
        dog.y = groundY;
        ctx.save();
        ctx.translate(sx, groundY - 28);
        if (dog.hit) {
          dog.timer += dt;
          dog.fade = Math.max(0, 1 - dog.timer * 1.6);
          ctx.rotate(0.35);
          ctx.globalAlpha = dog.fade;
        }
        ctx.fillStyle = '#2b2722';
        ctx.fillRect(-22, -12, 44, 24);
        ctx.fillRect(16, -20, 20, 16);
        ctx.fillStyle = '#d9c38f';
        ctx.fillRect(-20, 10, 8, 16);
        ctx.fillRect(6, 10, 8, 16);
        ctx.fillRect(-2, 10, 8, 16);
        ctx.fillRect(20, 10, 8, 16);
        ctx.fillStyle = '#443c33';
        ctx.fillRect(18, -32, 18, 16);
        ctx.fillStyle = '#fff';
        ctx.fillRect(28, -28, 6, 6);
        ctx.fillStyle = '#000';
        ctx.fillRect(30, -26, 3, 3);
        ctx.restore();
      });
    }

    // رسم السيارة
    function drawCar(cameraX) {
      const screenX = car.x - cameraX;
      const groundY = car.y;
      const bodyY = groundY - CAR.height - CAR.wheelRadius;
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      ctx.beginPath();
      ctx.ellipse(screenX, groundY - 8, 72, 16, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#111';
      ctx.beginPath();
      ctx.arc(screenX - 52, groundY - CAR.wheelRadius, CAR.wheelRadius, 0, Math.PI * 2);
      ctx.arc(screenX + 56, groundY - CAR.wheelRadius, CAR.wheelRadius, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#555';
      ctx.beginPath();
      ctx.arc(screenX - 52, groundY - CAR.wheelRadius, CAR.wheelRadius * 0.55, 0, Math.PI * 2);
      ctx.arc(screenX + 56, groundY - CAR.wheelRadius, CAR.wheelRadius * 0.55, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#050608';
      ctx.beginPath();
      ctx.moveTo(screenX - 84, bodyY + 14);
      ctx.quadraticCurveTo(screenX - 82, bodyY - 16, screenX - 42, bodyY - 42);
      ctx.lineTo(screenX + 38, bodyY - 46);
      ctx.quadraticCurveTo(screenX + 70, bodyY - 48, screenX + 84, bodyY - 8);
      ctx.lineTo(screenX + 86, bodyY + 34);
      ctx.lineTo(screenX - 84, bodyY + 34);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = '#1f344e';
      ctx.beginPath();
      ctx.moveTo(screenX - 36, bodyY - 36);
      ctx.lineTo(screenX + 20, bodyY - 40);
      ctx.lineTo(screenX + 12, bodyY - 8);
      ctx.lineTo(screenX - 32, bodyY - 6);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = '#1d1d1d';
      ctx.fillRect(screenX + 42, bodyY + 4, 52, 28);
      ctx.fillStyle = '#555';
      ctx.fillRect(screenX + 46, bodyY + 8, 44, 6);
      ctx.fillRect(screenX + 46, bodyY + 18, 44, 6);
      ctx.fillStyle = '#ff3b4d';
      ctx.font = 'bold 18px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('GMC', screenX + 68, bodyY + 22);
      const headlamp = state.nitroTimer > 0 ? '#ffe56a' : '#ffdca1';
      ctx.fillStyle = headlamp;
      ctx.fillRect(screenX + 84, bodyY + 6, 10, 14);
      ctx.fillRect(screenX - 88, bodyY + 6, 12, 14);
      if (!car.onGround) {
        ctx.fillStyle = 'rgba(232,200,140,0.3)';
        ctx.beginPath();
        ctx.arc(screenX - 70, groundY - 12, 18, 0, Math.PI * 2);
        ctx.arc(screenX + 70, groundY - 14, 18, 0, Math.PI * 2);
        ctx.fill();
      }
      if (state.boostTimer > 0) {
        ctx.fillStyle = 'rgba(255,196,90,0.35)';
        ctx.beginPath();
        ctx.arc(screenX - 110, groundY - 12, 30, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    // اكتشاف دعس الكلاب
    function checkDogs(dt) {
      const carFront = car.x + CAR.width * 0.32;
      dogs.forEach(dog => {
        if (dog.hit || dog.missed) return;
        const horizontalHit = Math.abs(carFront - dog.x) < 28;
        const verticalHit = Math.abs(car.y - dog.y) < 18;
        if (horizontalHit && verticalHit && car.onGround) {
          if (car.s >= GAME.V_hitMin) {
            dog.hit = true;
            registerCombo();
            const combo = getComboMultiplier();
            const gained = GAME.dogBase * combo;
            addScore(gained);
            state.hitSlowTimer = Math.max(state.hitSlowTimer, 0.6);
            spawnBlood(dog.x + 12, dog.y - 12);
            showBanner(`💥 دعسته! +${Math.round(gained)} • كومبو ×${combo.toFixed(2)}`, 1.2);
            playEffect('hit', 560, 0.4, 'square', 0.4);
            vib([60, 50, 60]);
          } else {
            dog.missed = true;
            resetCombo();
            addScore(-0);
            showToast('😬 فاتك — السرعة قليلة (لا نقاط)', 1.6);
            playEffect('miss', 200, 0.3, 'sine', 0.28);
          }
        }
      });
    }

    // تحديث المرحلة
    function updatePhase(x) {
      if (x < WORLD.chairX) state.phase = '🌵 إحماء';
      else if (x < WORLD.sandStart) state.phase = '🪑 كرسي';
      else if (x < WORLD.dogsStart) state.phase = '☁️ رمل ناعم';
      else if (x < WORLD.gateX) state.phase = '🐕 منطقة كلاب';
      else if (x < WORLD.bossX) state.phase = '🍽️ شاليمار';
      else if (x < WORLD.flagX) state.phase = '🤪 Boss Dumb & Dumber';
      else state.phase = '🏁 القمة';
    }

    function handleChair() {
      if (state.chairResolved) return;
      const carRear = car.x - CAR.width * 0.48;
      const carFront = car.x + CAR.width * 0.48;
      const hit = carFront > WORLD.chairX - 18 && carRear < WORLD.chairX + 18 && car.onGround;
      if (hit) state.chairTouched = true;
      if (car.x > WORLD.chairX + 120) {
        if (state.chairTouched) {
          addScore(-GAME.chairPenalty);
          GAME.duration += 5;
          showToast('💺 صدمنا الكرسي! -' + GAME.chairPenalty + ' (+5s)', 1.6);
          playEffect('miss', 210, 0.35, 'sine', 0.3);
        } else {
          addScore(GAME.chairBonus);
          showToast('💺 نجونا من الكرسي! +' + GAME.chairBonus, 1.4);
          playEffect('boost', 640, 0.35, 'triangle', 0.32);
        }
        state.chairResolved = true;
      }
    }

    // نهاية الجولة
    function endRun() {
      if (state.ended) return;
      state.ended = true;
      state.running = false;
      ui.end.classList.add('active');
      ui.endScore.textContent = Math.round(state.score);
      ui.endTime.textContent = state.time.toFixed(1) + 's';
      ui.endCombo.textContent = 'x' + state.maxCombo.toFixed(2);
      const summary = { score: Math.round(state.score), time: state.time, combo: state.maxCombo };
      let pbText = '--';
      try {
        if (!state.pb || summary.score > state.pb.score) {
          localStorage.setItem('sierra_pb_plus', JSON.stringify(summary));
          state.pb = summary;
        }
        pbText = state.pb.score + ' pts';
      } catch (err) {
        console.warn('PB save failed', err);
      }
      ui.endPB.textContent = state.pb ? `${state.pb.score} pts | ${state.pb.combo.toFixed(2)}x` : '--';
      showBanner('😂 طبخنا… بس نسينا الملح 🧂', 3.2);
      playEffect('boss', 220, 0.4, 'square', 0.34);
      vib([80, 160, 80]);
    }

    // إعادة التعيين
    function resetGame() {
      state.running = true;
      state.ended = false;
      state.time = 0;
      state.score = 0;
      state.comboLevel = 0;
      state.comboTimer = 0;
      state.maxCombo = 1;
      state.nitro = 2;
      state.winch = 1;
      state.nitroTimer = 0;
      state.boostTimer = 0;
      state.hitSlowTimer = 0;
      state.toastTimer = 0;
      state.bannerTimer = 0;
      state.qte = null;
      state.qteCooldown = 0;
      state.chairTouched = false;
      state.chairResolved = false;
      state.shalimarTriggered = false;
      state.shalimarChoice = null;
      state.massageActive = false;
      state.ooobaaaCooldown = 8;
      state.helicopterTriggered = false;
      state.helicopterTimer = 0;
      state.bossActive = false;
      state.bossTimer = 0;
      state.controlsFlipped = 0;
      state.choiceEvent = null;
      state.bossResolved = false;
      ui.toast.classList.remove('visible');
      ui.banner.classList.remove('visible');
      ui.qte.classList.remove('active');
      ui.end.classList.remove('active');
      topBarEl.classList.remove('invert');
      dogs.forEach(dog => {
        dog.hit = false;
        dog.missed = false;
        dog.timer = 0;
        dog.fade = 1;
      });
      tracks.length = 0;
      blood.length = 0;
      sandBursts.length = 0;
      car.x = 80;
      car.y = sampleGround(car.x);
      car.vx = 80;
      car.vy = 0;
      car.onGround = true;
    }

    restartBtn.addEventListener('click', resetGame);
    flipBtn.addEventListener('click', () => {
      input.flip *= -1;
      showToast(input.flip === 1 ? '↔️ الاتجاه طبيعي' : '↔️ الاتجاه مقلوب', 1.2);
    });

    // مدخلات لوحة المفاتيح
    window.addEventListener('keydown', e => {
      if (state.ended) {
        if (e.key === 'Enter') resetGame();
        return;
      }
      if (!sound.unlocked) unlockAudio();
      switch (e.key) {
        case 'ArrowLeft':
        case 'a':
          input.left = true;
          break;
        case 'ArrowRight':
        case 'd':
          input.right = true;
          break;
        case 'ArrowUp':
        case 'w':
        case ' ':
        case 'Spacebar':
          input.jumpQueued = true;
          break;
        case 'n':
        case 'N':
          input.nitroQueued = true;
          break;
        case 'w':
        case 'W':
          input.winchQueued = true;
          break;
        case 'K':
        case 'k':
          handleQTEKey('K');
          break;
        case 'L':
        case 'l':
          handleQTEKey('L');
          break;
        case '1':
          resolveChoice(1);
          break;
        case '2':
          resolveChoice(2);
          break;
        case '3':
          resolveChoice(3);
          break;
      }
      handleBossKey(e.key);
    });
    window.addEventListener('keyup', e => {
      switch (e.key) {
        case 'ArrowLeft':
        case 'a':
          input.left = false;
          break;
        case 'ArrowRight':
        case 'd':
          input.right = false;
          break;
      }
    });

    // أزرار اللمس
    controls.forEach(btn => {
      btn.addEventListener('pointerdown', ev => {
        ev.preventDefault();
        if (!sound.unlocked) unlockAudio();
        const hold = btn.dataset.hold;
        const tap = btn.dataset.tap;
        if (hold) {
          switch (hold) {
            case 'left':
              input.left = true;
              break;
            case 'right':
              input.right = true;
              break;
            case 'qteK':
              handleQTEKey('K');
              break;
            case 'qteL':
              handleQTEKey('L');
              break;
          }
        } else if (tap) {
          switch (tap) {
            case 'jump':
              input.jumpQueued = true;
              break;
            case 'nitro':
              input.nitroQueued = true;
              break;
            case 'winch':
              input.winchQueued = true;
              break;
            case 'choice1':
              resolveChoice(1);
              break;
            case 'choice2':
              resolveChoice(2);
              break;
            case 'choice3':
              resolveChoice(3);
              break;
          }
        }
      });
      btn.addEventListener('pointerup', () => {
        const hold = btn.dataset.hold;
        if (hold === 'left') input.left = false;
        if (hold === 'right') input.right = false;
      });
      btn.addEventListener('pointerleave', () => {
        const hold = btn.dataset.hold;
        if (hold === 'left') input.left = false;
        if (hold === 'right') input.right = false;
      });
    });

    qteButtons.forEach(btn => {
      btn.addEventListener('pointerdown', ev => {
        ev.preventDefault();
        handleQTEKey(btn.dataset.qte);
      });
    });

    canvas.addEventListener('pointerdown', unlockAudio, { once: true });

    // الحلقة الرئيسية
    let lastTime = performance.now();
    function frame(now) {
      const dtMs = clamp(now - lastTime, 8, 48);
      lastTime = now;
      const dt = dtMs / 1000;
      try {
        if (state.running && !state.ended) {
          update(dt);
        }
        render(dt);
      } catch (err) {
        console.error(err);
        ui.err.textContent = '⚠️ حدث خطأ غير متوقع';
        ui.err.style.display = 'block';
        state.running = false;
      }
      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);

    // تحديث المنطق
    function update(dt) {
      state.time += dt;
      state.ooobaaaCooldown -= dt;
      if (state.comboTimer > 0) {
        state.comboTimer -= dt;
        if (state.comboTimer <= 0) resetCombo();
      }
      updatePhase(car.x);
      handleChair();

      if (state.choiceEvent) {
        state.choiceEvent.timer -= dt;
        if (state.choiceEvent.timer <= 0) {
          resolveChoice(state.choiceEvent.default);
        }
      }

      if (state.qte) {
        state.qte.timer -= dt;
        state.qte.progress = clamp(state.qte.progress - dt * 0.12, 0, 1);
        ui.qteFill.style.width = (state.qte.progress * 100).toFixed(1) + '%';
        if (state.qte.timer <= 0) endQTE(false);
        updateHUD(dt);
        updateEngineAudio();
        return;
      }

      if (state.qteCooldown > 0) state.qteCooldown -= dt;

      let left = input.left;
      let right = input.right;
      if (state.controlsFlipped > 0) {
        state.controlsFlipped -= dt;
        [left, right] = [right, left];
      }
      const flip = input.flip;
      const effectiveLeft = flip === 1 ? left : right;
      const effectiveRight = flip === 1 ? right : left;

      let accel = 0;
      if (effectiveLeft) accel -= CAR.accel;
      if (effectiveRight) accel += CAR.accel;
      if (!effectiveLeft && !effectiveRight) {
        car.vx = lerp(car.vx, 0, CAR.friction * dt * 0.6);
      } else {
        car.vx += accel * dt;
      }

      if (state.nitroTimer > 0) {
        state.nitroTimer -= dt;
        car.vx += CAR.nitroForce * dt;
      }
      if (state.boostTimer > 0) state.boostTimer -= dt;
      if (state.hitSlowTimer > 0) state.hitSlowTimer -= dt;

      const slowFactor = state.hitSlowTimer > 0 ? 0.9 : 1;
      const sandZone = car.x > WORLD.sandStart && car.x < WORLD.sandEnd;
      const dragMultiplier = sandZone ? 1.45 : 1;
      car.vx *= 1 - CAR.airDrag * dt * dragMultiplier;
      car.vx = clamp(car.vx, CAR.maxReverse, CAR.maxSpeed * slowFactor + (state.boostTimer > 0 ? 140 : 0));

      if (input.jumpQueued) {
        tryJump();
        input.jumpQueued = false;
      }
      if (input.nitroQueued) {
        useNitro();
        input.nitroQueued = false;
      }
      if (input.winchQueued) {
        useWinch();
        input.winchQueued = false;
      }

      // حركة السيارة
      car.x += car.vx * dt;
      car.x = clamp(car.x, 0, WORLD.finish + 200);
      car.vy += CAR.gravity * dt;
      car.y += car.vy * dt;
      const groundY = sampleGround(car.x);
      if (car.y >= groundY) {
        if (!car.onGround && Math.abs(car.vy) > 140) {
          sandBursts.push({ x: car.x, y: groundY - 12, life: 0.7, dir: Math.sign(car.vx) || 1 });
        }
        if (!car.onGround) addTrack(car.x, groundY - 10);
        car.y = groundY;
        car.vy = 0;
        car.onGround = true;
      } else {
        car.onGround = false;
      }

      car.speedKMH = kmh(car.vx);
      car.s = car.speedKMH / 10;

      if (sandZone && state.qteCooldown <= 0 && Math.random() < dt * 0.08) {
        startQTE();
      }

      if (state.ooobaaaCooldown <= 0 && car.x > 3200) {
        if (Math.random() < dt * 0.2) eventOoobaaa();
      }

      if (!state.massageActive && car.x > 5200 && car.x < 5600 && Math.random() < dt * 0.12) {
        state.massageActive = true;
        eventMassage();
      }

      if (!state.shalimarTriggered && car.x > WORLD.gateX - 120) {
        eventShalimar();
      }

      if (!state.helicopterTriggered && state.time > 30 && state.time < 45) {
        if (Math.random() < dt * 0.15) eventHelicopter();
      }

      if (!state.bossActive && car.x > WORLD.bossX - 80 && !state.bossResolved) {
        state.bossResolved = true;
        eventBoss();
      }

      if (state.bossActive) {
        state.bossTimer -= dt;
        if (state.bossTimer <= 0) {
          state.bossActive = false;
          addScore(-GAME.bossPenalty);
          showToast('⏱️ فاتتك فرصة البوس! -' + GAME.bossPenalty, 1.6);
          playEffect('miss', 220, 0.35, 'sine', 0.28);
        }
      }

      if (state.massageActive && !state.choiceEvent) {
        state.massageActive = false;
      }

      checkDogs(dt);

      tracks.forEach(track => {
        track.x -= 0;
      });

      if (car.x >= WORLD.flagX) {
        showBanner('🏁 وصلنا القمة!', 2);
        endRun();
      } else if (state.time >= GAME.maxTime) {
        endRun();
      }

      updateHUD(dt);
      updateEngineAudio();
    }

    // الرسم
    function render(dt) {
      const w = canvas.width / dpr;
      const cameraX = clamp(car.x - w * 0.34, 0, WORLD.finish - w * 0.3);
      drawSky(cameraX);
      drawSand(cameraX, dt);
      drawTracks(cameraX, dt);
      drawGround(cameraX);
      drawSpectators(cameraX, dt);
      drawChair(cameraX);
      drawDogs(cameraX, dt);
      drawGate(cameraX);
      drawBossZone(cameraX);
      drawFinish(cameraX);
      drawBlood(cameraX, dt);
      drawCar(cameraX);
    }
  </script>
</body>
</html>
